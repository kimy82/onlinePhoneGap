<!DOCTYPE html>
    <html>  
      <head>  
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery.min.css" />
        <title>Hello World</title>
              <script type="text/javascript" src="cordova-2.5.0.js"></script>
              <script type="text/javascript" src="js/jquery.js"></script>
              <script type="text/javascript" src="js/jQueryMobile.js"></script>
              <script type="text/javascript" src="js/xui-2.3.2.js"></script>
		      <script type="text/javascript" src="js/index.js"></script>
		      <script type="text/javascript" charset="utf-8">  
						  var db = null;
						  var userToSave=null;
						  var userToDelete=null;
						  var userArray=null;
						  
						 
						  function User(name) {
								var _self=this;
								this.name= name;
								this.getName = function(){
									return _self.name;
								}
							}
						  var displayHello = function() {  
									                        var name =      document.getElementById("firstname").value;  
									                        navigator.notification.alert("name" + name);  
						            					} 
						  var saveToStorage = function(){
															var name =      document.getElementById("firstname").value;  
															userToSave = new User(name);
															$('ul').append('<li><a>'+name+'</a></li>').listview('refresh');
															db.transaction(queryInsertUser, errorCB);
						
														}
						  var showUsers = function(){
															db.transaction(querySelectUsers, errorCB2);
													}
													
						    document.addEventListener("deviceready", onDeviceReady, false);
						    function onDeviceReady() {
						        db = window.openDatabase("online", "1.0", "StorageUserDemo", 200000);
						        db.transaction(populateDB, errorCB, successCB);
						    }
						    function populateDB(tx) {
						         tx.executeSql('DROP TABLE IF EXISTS USERS');
						         tx.executeSql('CREATE TABLE IF NOT EXISTS USERS (name UNIQUE)');
						         tx.executeSql('INSERT INTO USERS (name) VALUES ("KIMY")');
								 
						    }
						    function errorCB(tx, err) {
						        alert("Error processing SQL: "+err);
						    }
							 function errorCB2(tx, err) {
						        alert("Error processing SQL: "+err);
						    }
						    function successCB() {
						        console.log("success!");
						    }
						
						
							function queryInsertUser(tx) {
								console.log("User to save= " + userToSave.getName());
								tx.executeSql('INSERT INTO USERS (name) VALUES ("'+userToSave.getName()+'")');
							}
							function queryInsertUsers(tx) {
								console.log("User to save= " + userArray);
								for(i=0;i<userArray.length;i++){
								console.log("userArray-------"+userArray[i]);
									tx.executeSql('INSERT INTO USERS (name) VALUES ("'+userArray[i].getName()+'")');
								}
							}
							function queryDeleteUsers(tx) {
																
									tx.executeSql('DELETE USERS where name='+userToDelete.getName());								
							}
							function querySelectUsers(tx) {
								tx.executeSql('SELECT * FROM USERS', [], querySuccessUser, errorCB2);
							}

							function querySuccessUser(tx, results) {
								console.log("Returned rows = " + results.rows.length);
								var len = results.rows.length;
								var llistat="";
								 for (var i=0; i<len; i++){
									console.log("Row = " + i + " ID = " + results.rows.item(i).name);
									llistat=llistat+ results.rows.item(i).name+"-";
								}										
							}
							
							function callWebService(){
						      
						        var url = "http://10.0.2.2:9090/Spring/rest/dao";
						        x$.data = {};
						        $('ul').html("");
						        x$("#search_tweet_button").xhr(url,{
						          error: function(){alert("failed"+this.responseText)},
						          callback: function(){						          
						             var jsonResponse = eval("("+this.responseText+")");						            
						          	  userArray = new Array();
							          $.each(jsonResponse, function(index, value) { 		
									          	if(value.username!='undefined'){       										          		
									          			console.log(value.username);	
									          			$('ul').append('<li><a href="#infoUser" onclick="createUser(\''+value.username+'\')" >'+value.username+'</a></li>').listview('refresh');		 	
														userArray[index] = new User(value.username);													
												}
																			 									       						
										});
										
										db.transaction(queryInsertUsers, errorCB);						         
						          }
						        });
						      }
						      function createUser(name){
						       	userToDelete = new User(name);	
						      }
						      function deleteUser(){
						      
						        var url = "http://10.0.2.2:9090/Spring/rest/dao/delete?user="+userToDelete.getName();
						        x$.data = {};
						        x$("#search_tweet_button").xhr(url,{
						          error: function(){alert("failed"+this.responseText)},
						          callback: function(){		
						          				          
						             var jsonResponse = eval("("+this.responseText+")");						            						          											
									 db.transaction(queryDeleteUsers, errorCB);						         
						          }
						        });
						      }
						      var controlUser={
						      						_init: function(){
						      							this._self=this;
						      						},
											      	check: function(){
											      		var username = window.localStorage.getItem("user.username");
											      		var login = window.localStorage.getItem("user.login");
											      		if(username==null || login==null){
											      			$('#logUser').page();
											      		}
											      		var url = "http://10.0.2.2:9090/Spring/rest/dao/login?user="+username+"&pass="+login;
											        	x$.data = {};
												        $('ul').html("");
												        x$("#search_tweet_button").xhr(url,{
												          error: function(){alert("failed"+this.responseText)},
												          callback: function(){						          
												             var jsonResponse = eval("("+this.responseText+")");						            												          	 						            
												          	 if(jsonResponse.ok=='ok'){												          	 	
												          	 	$.mobile.changePage("#list", { transition: "slideup"});
												          	 }else{
												          	 	$.mobile.changePage("#logUser", { transition: "slideup"});	
												          	 }					         
												          }
												        });
											      	},											      
											      	logUser: function(){
											      		var username =$("#username").val();
											      		var login =$("#password").val();
											      		
											      		var url = "http://10.0.2.2:9090/Spring/rest/dao/login?user="+username+"&pass="+login;
											        	x$.data = {};
												        $('ul').html("");
												        x$("#userToLog").xhr(url,{
												          error: function(){alert("failed"+this.responseText)},
												          callback: function(){						          
												             var jsonResponse = eval("("+this.responseText+")");						            
												          	 if(jsonResponse.ok=='ok'){
												          	 	controlUser.setUserStorage(jsonResponse.username,jsonResponse.password);
												          	 	$.mobile.changePage("#list", { transition: "slideup"});
												          	 	
												          	 }else{
												          	 	$.mobile.changePage("#logUser", { transition: "slideup"});												          	 	
												          	 }		         
												          }
												        });
											      	},
											      	setUserStorage: function(user,password){
											      		window.localStorage.setItem("user.username",user);
											      		window.localStorage.setItem("user.login",password);											      		
											      	}
						      }
						      controlUser._init();			
						      controlUser.check();			   
					</script>
        </head>  
        <body id="bdy" >  
        <div data-role="page" id="logUser" >
        	<div data-role="header">
				<h1>LOGIN</h1>
			</div>
        	<div data-role="content" >
    				
	   				 <input name="username" id="username" placeholder="Text input" value="" data-clear-btn="true" type="text">
	   				 <input name="password" id="password" placeholder="Text input" value="" data-clear-btn="true" type="password">
	       	</div>			
			<div data-role="footer">
					<h4><p><a href="#" data-role="button" id="userToLog" onclick="controlUser.logUser();">ENTER</a></p></h4>
			</div>
		</div>
        <div data-role="page" id="list" >
	        	<div data-role="header">
					<h1>Users</h1>
				</div>
	        	<div data-role="content" >
	       		
		       		 <ul data-role="listview" data-inset="true" data-filter="true">
					    <li><a href="#">Acura</a></li>
					    <li><a href="#">Audi</a></li>
					    <li><a href="#">BMW</a></li>
					    <li><a href="#">Cadillac</a></li>
					    <li><a href="#">Ferrari</a></li>
					</ul>
				</div>
				<div data-role="footer">
					<h4><p><a href="#insert">Insert User</a></p></h4>
				</div>
		</div>
		<div data-role="page" id="insert" >
        	<div data-role="header">
				<h1>Users</h1>
			</div>
        	<div data-role="content" >
    			<label for="firstname">User name:</label>
    			<input name="firstname" id="firstname" placeholder="Text input" value="" data-clear-btn="true" type="text">
	            
	   				 <a href="#" data-role="button" onclick="saveToStorage();">Save to storage</a>  
	   				 <a href="#" data-role="button" id="search_tweet_button" class="btn" onclick="callWebService();">Load Users</a>  
 
	            <div id="tweet" ></div>
       		
	       	</div>			
			<div data-role="footer">
					<h4><p><a href="#list">List</a></p></h4>
			</div>
		</div>
		<div data-role="page" id="infoUser" >
        	<div data-role="header">
				<h1>Info User</h1>
			</div>
        	<div data-role="content" >
    				
	   				 <a href="#" data-role="button" id="userToDelete" onclick="deleteUser();">Delete the user</a>  
	       	</div>			
			<div data-role="footer">
					<h4><p><a href="#list">List</a></p></h4>
			</div>
		</div>		
 	 	</body> 
    </html>  
