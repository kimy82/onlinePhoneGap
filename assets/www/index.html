<!DOCTYPE html>
    <html>  
      <head>  
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery.min.css" />
        <title>Online</title>
              <script type="text/javascript" src="cordova-2.5.0.js"></script>
              <script type="text/javascript" src="js/jquery.js"></script>
              <script type="text/javascript" src="js/jQueryMobile.js"></script>
		      <script type="text/javascript" src="js/index.js"></script>
			  <script type="text/javascript" src="js/resources.js"></script>
		      <script type="text/javascript" charset="utf-8">  
		      
		      
		      			$(document).on("mobileinit", function(){
						  $.mobile.allowCrossDomainPages = true;
						  $.support.cors = true;
						
						});
						
						document.addEventListener("deviceready", onDeviceReady, false);
						function onDeviceReady() {
						    	console.log("database creating");
						        db = window.openDatabase("online", "1.0", "StorageCatalog", 200000);
						        db.transaction(controlDB.populateClientDB, controlDB.errorCB, controlDB.successCB);
						}
						
						  var db = null;
						  var userToSave=null;
						  var userToDelete=null;
						  var userArray=null;						  
						  
						 
						  function Client(name) {
								var _self=this;
								this.name= name;
								this.getName = function(){
									return _self.name;
								}
							}
						  var displayHello = function() {  
									                        var name =      document.getElementById("firstname").value;  
									                        navigator.notification.alert("name" + name);  
						            					} 
						  var saveToStorage = function(){
															var name =      document.getElementById("firstname").value;
															var pass =      document.getElementById("passNewUser").value;  
															controlUser.insertUser(name,pass); 
															userToSave = new User(name);
															$('ul').append('<li><a>'+name+'</a></li>').listview('refresh');
															db.transaction(queryInsertUser, errorCB);
						
														}
						  var showUsers = function(){
															db.transaction(querySelectUsers, errorCB2);
													}
													
						  
						    function populateDB(tx) {
						    	 console.log("table creating");
						         //tx.executeSql('DROP TABLE IF EXISTS CLIENTS');
						         tx.executeSql('CREATE TABLE IF NOT EXISTS CLIENTS (name UNIQUE, id UNIQUE)');
						         //tx.executeSql('INSERT INTO CLIENTS (name) VALUES ("KIMY")');
						         console.log("table created");
								 
						    }
						    function errorCB(tx, err) {
						       console.log("Error processing SQL: "+err);
						    }
							 function errorCB2(tx, err) {
						        console.log("Error processing SQL: "+err);
						    }
						    function successCB() {
						        console.log("success!");
						    }
						
						
							function queryInsertUser(tx) {
								console.log("User to save= " + userToSave.getName());
								tx.executeSql('INSERT INTO USERS (name) VALUES ("'+userToSave.getName()+'")');
							}
							function queryInsertUsers(tx) {
								console.log("User to save= ");
								tx.executeSql('DELETE FROM USERS where 1=1');
								console.log("Delete");
								for(i=0;i<userArray.length;i++){	
									var query = 'INSERT INTO USERS (name) VALUES ("'+userArray[i].getName()+'")';
									console.log(query);										
									tx.executeSql('INSERT INTO USERS (name) VALUES ("'+userArray[i].getName()+'")');
								}
							}
							function queryDeleteUsers(tx) {
																
									tx.executeSql('DELETE USERS where name='+userToDelete.getName());								
							}
							function querySelectUsers(tx) {
								tx.executeSql('SELECT * FROM USERS', [], querySuccessUser, errorCB2);
							}

							function querySuccessUser(tx, results) {
								console.log("Returned rows = " + results.rows.length);
								var len = results.rows.length;
								var llistat="";
								 for (var i=0; i<len; i++){
									console.log("Row = " + i + " ID = " + results.rows.item(i).name);
									llistat=llistat+ results.rows.item(i).name+"-";
								}										
							}
							
						      function createUser(name){
						       	userToDelete = new User(name);	
						      }
							 var controlDB ={
												_init: function(){
						      							this._self=this;
														this.clientArray=new Array();														
						      					},
												populateClientDB: function(tx) {
													 console.log("table creating");
													 tx.executeSql('DROP TABLE IF EXISTS CLIENTS');
													 tx.executeSql('CREATE TABLE IF NOT EXISTS CLIENTS (name UNIQUE)');
													 //tx.executeSql('INSERT INTO CLIENTS (name) VALUES ("KIMY")');
													 console.log("table created");													 													 
												},
												errorCB: function(tx, err) {
												   console.log("Error creating client table SQL: "+err);
												},
												successCB: function() {
													console.log("success: client table created!");
												},
												fillClient: function(){
													console.log("filling clients table");
													var username = window.localStorage.getItem("user.username");
													 var url = "http://77.228.245.51/Spring/rest/dao?user="+username;
													      $('ul').html("");
															      $.ajax({
															       			url: url,
																	        type: "GET",
																			async: true,
																			dataType: 'json',
																			cache : false,													         
																			success: function ( jsonResponse ) {
																					  
																			          $.each(jsonResponse, function(index, value) { 		
																					          	if(value.username!='undefined'){       										          		
																					          			console.log(value.username);
																										$('ul#clientsList').append('<li><a href="#infoUser" onclick="controlClient.createClient(\''+value.username+'\')" >'+value.username+'</a></li>').listview('refresh');		 		
																										controlDB.clientArray[index] = new Client(value.username);													
																								}																						 									       					
																						});																			
																						db.transaction(controlDB.queryInsertUsers, controlDB.errorCB);		
																				}
																	});	
													console.log("end filling clients table");
												},
												queryInsertUsers: function(tx) {
													console.log("Inserting clients ");
										
													for(i=0;i<userArray.length;i++){	
														var query = 'INSERT INTO CLIENTS (name) VALUES ("'+userArray[i].getName()+'")';
														console.log(query);										
														tx.executeSql(query);
													}
												},
							 }
							 var controlPage={	
												_userRole:"ROLE_CLIENT",
												_init: function(){
						      							this._self=this;														
						      					},
												createMenuPrincipal: function(){
													controlPage._initRole();
													if(controlPage._userRole=='ROLE_CLIENT'){
														controlPage._createMenuClient();
													}else if(controlPage._userRole=='ROLE_ADMIN'){
														controlPage._createMenuAdmin();
													}else if(controlPage._userRole=='ROLE_SUPERADMIN'){
														controlPage._createMenuSuperAdmin();
													}else{
														console.log("ERROR: No hi ha role per defecte fem el del client");
														controlPage._createMenuClient();
													}
													
												},
												_initRole(){
													var role = window.localStorage.getItem("user.role");
													if(role!=null){
														controlPage._userRole=role;
													}else{
														console.log("ERROR: No hi ha role per defecte fem el del client");
														controlPage._userRole='ROLE_CLIENT';
													}
												},
												_createMenuClient: function(){
													$('ul#menuList').append('<li><a href="#cataleg">'+Translation.getText(2,null)+'</a></li>').listview('refresh');		 	
													$('ul#menuList').append('<li><a href="#notificacio">'+Translation.getText(3,null)+'</a></li>').listview('refresh');
													$('ul#menuList').append('<li><a href="#companyInfo">'+Translation.getText(4,null)+'</a></li>').listview('refresh');
												},
												_createMenuAdmin: function(){
													
													$('ul#menuList').append('<li><a href="#cataleg">'+Translation.getText(2,null)+'</a></li>').listview('refresh');		 	
													$('ul#menuList').append('<li><a href="#notificacio">'+Translation.getText(3,null)+'</a></li>').listview('refresh');
													$('ul#menuList').append('<li><a href="#companyInfo">'+Translation.getText(4,null)+'</a></li>').listview('refresh');
													$('ul#menuList').append('<li><a href="#clients">'+Translation.getText(5,null)+'</a></li>').listview('refresh');
													$('ul#menuList').append('<li><a href="#createProduct">'+Translation.getText(6,null)+'</a></li>').listview('refresh');
													controlDB.fillClient();
												},
												_createMenuSuperAdmin: function(){
													
													$('ul#menuList').append('<li><a href="#cataleg">'+Translation.getText(2,null)+'</a></li>').listview('refresh');		 	
													$('ul#menuList').append('<li><a href="#notificacio">'+Translation.getText(3,null)+'</a></li>').listview('refresh');
													$('ul#menuList').append('<li><a href="#companyInfo">'+Translation.getText(4,null)+'</a></li>').listview('refresh');
													$('ul#menuList').append('<li><a href="#clients">'+Translation.getText(5,null)+'</a></li>').listview('refresh');
													$('ul#menuList').append('<li><a href="#createProduct">'+Translation.getText(6,null)+'</a></li>').listview('refresh');
													controlDB.fillClient();
													
												},
							 
							 }				      	
					
						       var controlClient={
						      						_init: function(){
						      							this._self=this;
														this.client=null;
						      						},											
													createClient: function(name){
														controlClient.client = new Client(name);	
													},
						      
						      var controlUser={
						      						_init: function(){
						      							this._self=this;
						      						},
											      	check: function(){
											      		var username = window.localStorage.getItem("user.username");
											      		var login = window.localStorage.getItem("user.login");
											      		if(username==null || login==null){
											      			$.mobile.changePage("#logUser", { transition: "slideup"});	
															return;
											      		}
											      		$.ajax({
						       								   url: "http://77.228.245.51/Spring/rest/dao/login?user="+username+"&pass="+login,
													           type: "GET",
													           dataType: 'json',
													           cache : false,													         
													            success: function ( data ) {

														           	if(data.ok=='ok'){
														          	 	controlUser.setUserStorage(data.username,data.password,data.companyName,data.companyId,data.role);
																		controlPage.createMenuPrincipal();
														          	 	$.mobile.changePage("#menu", { transition: "slideup"});														          	 	
														          	 }else{																		
														          	 	$.mobile.changePage("#logUser", { transition: "slideup"});												          	 	
														          	 }
														          }
													        });		
											      	},											      
											      	logUser: function(){
											      		var username =$("#username").val();
											      		var login =$("#password").val();											      	
											      		var url = "http://10.0.2.2:9090/Spring/rest/dao/login"; 
											        
																//10.0.2.2		        	                  						       
						       							$.ajax({
						       								   url: "http://77.228.245.51/Spring/rest/dao/login?user="+username+"&pass="+login,
													           type: "GET",
													           dataType: 'json',
													           cache : false,													         
													            success: function ( data ) {														           
														           	if(data.ok=='ok'){
														          	 	controlUser.setUserStorage(data.username,data.password,data.companyName,data.companyId,data.role);
																		controlPage.createMenuPrincipal();
														          	 	$.mobile.changePage("#menu", { transition: "slideup"});
														          	 	
														          	 }else{
																		$("#error.login").text(Translation.getText(1,null));
														          	 	$.mobile.changePage("#logUser", { transition: "slideup"});												          	 	
														          	 }
														          }
													        });													      						          												           
											      	},
											      	setUserStorage: function(user,password,companyName,companyId,idioma,role){
											      		window.localStorage.setItem("user.username",user);
											      		window.localStorage.setItem("user.login",password);		
														window.localStorage.setItem("user.role",role);	
														window.localStorage.setItem("user.companyName",companyName);
														window.localStorage.setItem("user.companyId",companyId);
														window.localStorage.setItem("user.idioma",idioma);
											      	},
													deleteUserStorage: function(){
											      		window.localStorage.removeItem("user.username");
											      		window.localStorage.removeItem("user.login");	
														window.localStorage.removeItem("user.role");
														window.localStorage.removeItem("user.companyName");
														window.localStorage.removeItem("user.companyId");
														window.localStorage.removeItem("user.idioma");
											      	},
											      	deleteUser: function(){
						      
												        var url = "http://77.228.245.51/Spring/rest/dao/delete?user="+userToDelete.getName();
												        
												        	$.ajax({
												       			url: url,
														        type: "GET",
																dataType: 'json',
																cache : false,													         
																success: function ( data ) {	
																 						   navigator.notification.alert("DELETED");   																			           
																				           db.transaction(queryDeleteUsers, errorCB);																					             	
																				           $.mobile.changePage("#insert", { transition: "slideup"});
																				          }
																});	
						     						 },						     				
						     						 insertUser: function(user,pass){
						      
												        var url = "http://77.228.245.51/Spring/rest/dao/insert?user="+user+"&pass="+pass;
												        
												        	$.ajax({
												       			url: url,
														        type: "GET",
																dataType: 'json',
																cache : false,													         
																success: function ( data ) {
																				       navigator.notification.alert("SAVED");   																				          
																				          }
																});	
						     						 }
						      }
						      controlUser._init();
							  controlPage._init();
							  controlDB._init();
							  controlClient._init();
						      controlUser.check();		
						   		   
					</script>
        </head>  
        <body id="bdy" > 
        <div data-role="page" id="logUser" >
        	<div data-role="header">
				<h1>LOGIN</h1>
			</div>
        	<div data-role="content" >    				
	   				<label for="username" id="usernameLabel"></span> <input name="username" id="username" placeholder="Text input" value="" data-clear-btn="true" type="text">
	   				<label for="password" id="passwordLabel"></span> <input name="password" id="password" placeholder="Text input" value="" data-clear-btn="true" type="password">
	       	</div>			
			<div data-role="footer">
					<h4><p><a href="#" data-role="button" id="user" onclick="controlUser.logUser();"><label  id="enterLabel"></span></a></p></h4><br>
					<h4><p><span id="error.login" style="color: red;" ></span></p></h4>
			</div>
		</div> 
		<div data-role="page" id="menu" >
	        	<div data-role="header">
					<h1>Catalog</h1>
				</div>
	        	<div data-role="content" >
					
		       		<ul id="menuList" data-role="listview" data-inset="true" data-filter="true">
					  
					</ul>
				</div>
				<div data-role="footer">
					<h4><p><a href="#insert">Insert User</a></p></h4>
					<h4><p><a href="pages/capture.html">Video</a></p></h4>
				</div>
		</div>
        <div data-role="page" id="clients" >
	        	<div data-role="header">
					<h1>Users</h1>
				</div>
	        	<div data-role="content" >
					<ul id="clientsList" data-role="listview" data-inset="true" data-filter="true">
					  
					</ul>
		       		 
				</div>
				<div data-role="footer">
					<h4><p><a href="#insert">Insert User</a></p></h4>
					<h4><p><a href="pages/capture.html">Video</a></p></h4>
				</div>
		</div>
       
		<div data-role="page" id="insert" >
        	<div data-role="header">
				<h1>Users</h1>
			</div>
        	<div data-role="content" >
    			<label for="firstname">User name:</label>
    			<input name="firstname" id="firstname" placeholder="Text input" value="" data-clear-btn="true" type="text">
    			<input name="passNewUser" id="passNewUser" placeholder="Text input" value="" data-clear-btn="true" type="text">
	            
	   				 <a href="#" data-role="button" onclick="saveToStorage();">Save to storage</a>  	   				
 
	            <div id="tweet" ></div>
       		
	       	</div>			
			<div data-role="footer">
					<h4><p><a href="#list">List</a></p></h4>
			</div>
		</div>
		<div data-role="page" id="infoUser" >
        	<div data-role="header">
				<h1>Info User</h1>
			</div>
        	<div data-role="content" >
    				
	   				 <a href="#" data-role="button" id="userToDelete" onclick="controlUser.deleteUser();">Delete the user</a>  
	       	</div>			
			<div data-role="footer">
					<h4><p><a href="#list">List</a></p></h4>
			</div>
		</div>		
 	 	</body> 
    </html>  